<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Water Check-in üíß</title>
  <style>
    :root {
      --bg: #f5f3ff;
      --card-bg: #ffffff;
      --accent: #4c6fff;
      --accent-soft: #c7d2ff;
      --text-main: #111827;
      --text-muted: #6b7280;
      --shadow: 0 18px 40px rgba(15, 23, 42, 0.16);
      --border-dashed: rgba(148, 163, 184, 0.5);
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top left, #e0f2fe, #f5f3ff 50%, #fee2e2);
      color: var(--text-main);
      position: relative;
      overflow-x: hidden;
    }

    .app {
      position: relative;
      background: var(--card-bg);
      border-radius: 26px;
      padding: 24px 26px 22px;
      width: 400px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(148, 163, 184, 0.18);
      z-index: 1;
    }

    .app-header { margin-bottom: 14px; }

    .title {
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .title-emoji { font-size: 22px; }

    .date {
      margin-top: 4px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .sub {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .sound-row {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 10px;
    }

    .sound-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-muted);
      cursor: pointer;
    }

    .sound-toggle input { display: none; }

    .sound-toggle-pill {
      width: 32px;
      height: 16px;
      background: #e5e7eb;
      border-radius: 999px;
      position: relative;
      transition: background 0.15s ease;
    }

    .sound-toggle-knob {
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: #ffffff;
      position: absolute;
      top: 2px;
      left: 2px;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.3);
      transition: transform 0.15s ease;
    }

    .sound-toggle input:checked + .sound-toggle-pill { background: #4c6fff; }
    .sound-toggle input:checked + .sound-toggle-pill .sound-toggle-knob { transform: translateX(14px); }
    .sound-toggle-label { user-select: none; }

    .user-tabs {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
  margin: 10px 0 16px;
}

.user-tab {
  width: 100%;
  padding: 6px 0;
  border-radius: 999px;
  border: 1px solid rgba(148, 163, 184, 0.4);
  font-size: 12px;
  background: #f9fafb;
  color: #4b5563;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  transition: background 0.15s ease, color 0.15s ease,
    border-color 0.15s ease, transform 0.08s ease;
}

    .user-tab span.emoji { font-size: 14px; }

    .user-tab.active {
      background: #4c6fff;
      color: white;
      border-color: #4c6fff;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.35);
    }

    .goal-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 12px 0 16px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .goal-row span.label {
      font-weight: 500;
      color: var(--text-main);
    }

    .goal-input {
      width: 56px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      padding: 4px 8px;
      font-size: 12px;
      text-align: center;
      outline: none;
    }

    .goal-input:focus {
      border-color: #4c6fff;
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.3);
    }

    .goal-input[disabled] {
      background: #f3f4f6;
      color: #6b7280;
      cursor: not-allowed;
    }

    .glasses-row {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin: 6px 0 18px;
    }

    .glass-btn {
      border: none;
      background: #f3f4ff;
      border-radius: 999px;
      padding: 4px 0 3px;
      cursor: pointer;
      font-size: 19px;
      transition: transform 0.1s ease-out, box-shadow 0.1s ease-out,
        background 0.15s ease-out;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.12);
    }

    .glass-btn.filled {
      background: #dbeafe;
      box-shadow: 0 3px 8px rgba(37, 99, 235, 0.25);
    }

    .glass-btn.pop { animation: glassPop 0.25s ease-out; }

    @keyframes glassPop {
      0% { transform: translateY(3px) scale(0.9); }
      60% { transform: translateY(-2px) scale(1.12); }
      100% { transform: translateY(0) scale(1); }
    }

    .office-note {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 14px;
    }

    .pill {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #ecfeff;
      color: #0369a1;
      border: 1px solid #bae6fd;
    }

    .time-left {
      margin-top: 6px;
      margin-bottom: 16px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .meters-card {
      margin-top: 18px;
      padding-top: 10px;
      border-top: 1px dashed var(--border-dashed);
      font-size: 12px;
    }

    .meters-title {
      font-weight: 600;
      margin-bottom: 10px;
    }

    .person-card {
      background: #ffffff;
      border-radius: 18px;
      padding: 10px 12px;
      margin-bottom: 12px;
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.18);
      border: 1px solid rgba(148, 163, 184, 0.18);
    }

    .person-inner { display: flex; align-items: stretch; gap: 10px; }

    .person-left {
      flex: 2;
      display: flex;
      flex-direction: column;
      gap: 5px;
      min-width: 0;
    }

    .person-right {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding-left: 10px;
      border-left: 1px dashed var(--border-dashed);
    }

    .person-toprow {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 6px;
    }

    .meter-name {
      display: flex;
      align-items: center;
      gap: 4px;
      font-weight: 500;
      color: var(--text-main);
    }

    .meter-name span.emoji { font-size: 16px; }

    .meter-bar {
      width: 100%;
      height: 7px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
      position: relative;
    }

    .meter-inner {
      height: 100%;
      background: linear-gradient(90deg, #a5b4fc, #4c6fff);
      width: 0%;
      transition: width 0.25s ease-out, background 0.2s ease-out;
    }

    .meter-text {
      margin-top: 3px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .meter-message {
      margin-top: 1px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .streak-main {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 2px;
    }

    .streak-number {
      font-size: 18px;
      line-height: 1.1;
      color: var(--text-main);
      font-weight: 700;
    }

    .streak-fire { font-size: 16px; line-height: 1.1; }

    .streak-label {
      font-size: 10px;
      text-transform: lowercase;
      color: var(--text-muted);
    }

    .confetti-piece {
      position: fixed;
      font-size: 18px;
      animation: confettiFall 1.2s ease-out forwards;
      pointer-events: none;
      z-index: 9999;
    }

    @keyframes confettiFall {
      0% { opacity: 1; transform: translateY(0) rotate(0deg); }
      100% { opacity: 0; transform: translateY(260px) rotate(30deg); }
    }

    .glass-drop {
      position: absolute;
      font-size: 18px;
      pointer-events: none;
      animation: dropIntoGlass 0.38s ease-out forwards;
      z-index: 5;
    }

    @keyframes dropIntoGlass {
      0% { transform: translateY(-14px); opacity: 0; }
      20% { opacity: 1; }
      100% { transform: translateY(6px); opacity: 0; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="title">
        <span class="title-emoji">üíß</span>
        <span>Water check-in</span>
      </div>
      <div class="date" id="date"></div>
    </header>

    <p class="sub">Pick who you‚Äôre logging for, then tap to update.</p>

    <div class="sound-row">
      <label class="sound-toggle">
        <input type="checkbox" id="sound-toggle-input" />
        <span class="sound-toggle-pill">
          <span class="sound-toggle-knob"></span>
        </span>
        <span class="sound-toggle-label">Sound effects</span>
      </label>
    </div>

    <div class="user-tabs" id="user-tabs"></div>

    <div class="goal-row">
      <span class="label" id="goal-label">Daily goal for this person</span>
      <span>
        <input id="goal-input" class="goal-input" type="number" min="1" max="15" />
        <span id="goal-unit" style="font-size:11px;color:var(--text-muted);">glasses</span>
      </span>
    </div>

    <div class="glasses-row" id="glasses-row"></div>

    <div class="office-note">
      <span>Office hours: 09:00‚Äì17:30</span>
      <span class="pill" id="status-pill">Today</span>
    </div>
    <div class="time-left" id="time-left"></div>

    <div class="meters-card">
      <div class="meters-title">Water meter üíß</div>
      <div id="meters-list"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      doc,
      setDoc,
      collection,
      query,
      onSnapshot,
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAh3Wqa8NSzdWIXRNBJ6TqYHgNm8y7faI",
      authDomain: "hydration-buddies-5fa86.firebaseapp.com",
      projectId: "hydration-buddies-5fa86",
      storageBucket: "hydration-buddies-5fa86.appspot.com",
      messagingSenderId: "23662841356",
      appId: "1:23662841356:web:41c2195ab1acb139439329",
      measurementId: "G-FVEE8GDG13"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const GROUP_ID = "hydration-besties";

    const USERS = [
      { id: "joan",  name: "Joan",  emoji: "üßù‚Äç‚ôÄÔ∏è", cadence: "daily",  defaultGoal: 8 },
      { id: "loes",  name: "Loes",  emoji: "üê±",    cadence: "daily",  defaultGoal: 8 },
      { id: "john",  name: "John",  emoji: "üí™",    cadence: "daily",  defaultGoal: 8 },
      { id: "plant", name: "Perry", emoji: "üåø",    cadence: "weekly", defaultGoal: 1 },
    ];

    const MAX_GLASSES = 15;
    const OFFICE_START_H = 9;
    const OFFICE_START_M = 0;
    const OFFICE_END_H = 17;
    const OFFICE_END_M = 30;

    const STORAGE_PREFIX = "waterTracker_v12_";

    const now = new Date();
    const todayKey = now.toISOString().slice(0, 10);

    const dateEl = document.getElementById("date");
    const userTabsEl = document.getElementById("user-tabs");
    const goalInputEl = document.getElementById("goal-input");
    const goalLabelEl = document.getElementById("goal-label");
    const goalUnitEl  = document.getElementById("goal-unit");
    const glassesRowEl = document.getElementById("glasses-row");
    const statusPill = document.getElementById("status-pill");
    const timeLeftEl = document.getElementById("time-left");
    const metersListEl = document.getElementById("meters-list");
    const soundToggleInput = document.getElementById("sound-toggle-input");
    const appEl = document.querySelector(".app");

    function clamp(val, min, max) {
      return Math.min(max, Math.max(min, val));
    }

    function formatDatePretty(d) {
      return d.toLocaleDateString(undefined, {
        weekday: "long",
        day: "2-digit",
        month: "long",
        year: "numeric",
      });
    }

    // --- Period keys (daily vs weekly) ---
    function toDateKey(d) {
      return d.toISOString().slice(0, 10); // YYYY-MM-DD
    }

    // ISO-ish week key: YYYY-Www
    function toWeekKey(d) {
      const date = new Date(d);
      date.setHours(0, 0, 0, 0);

      // Thursday in current week decides the year
      date.setDate(date.getDate() + 3 - ((date.getDay() + 6) % 7));
      const weekYear = date.getFullYear();

      // Week 1 is the week with Jan 4th
      const week1 = new Date(weekYear, 0, 4);
      const week1Day = (week1.getDay() + 6) % 7;
      week1.setDate(week1.getDate() - week1Day);

      const diffDays = Math.round((date - week1) / 86400000);
      const week = 1 + Math.floor(diffDays / 7);
      return `${weekYear}-W${String(week).padStart(2, "0")}`;
    }

    function getUser(userId) {
      return USERS.find(u => u.id === userId) || USERS[0];
    }

    function getPeriodKeyForUser(user, d = new Date()) {
      return user.cadence === "weekly" ? toWeekKey(d) : toDateKey(d);
    }

    function dayKeyOffset(offsetDays) {
      const d = new Date();
      d.setDate(d.getDate() + offsetDays);
      return toDateKey(d);
    }

    function weekKeyOffset(offsetWeeks) {
      const d = new Date();
      d.setDate(d.getDate() + offsetWeeks * 7);
      return toWeekKey(d);
    }

    // --- Storage keys ---
    function storageKeyCount(userId, periodKey) {
      return `${STORAGE_PREFIX}count_${periodKey}_${userId}`;
    }
    function storageKeyGoal(userId) {
      return `${STORAGE_PREFIX}goal_${userId}`;
    }
    function storageKeySelectedUser() {
      return `${STORAGE_PREFIX}selectedUser`;
    }
    function storageKeySounds() {
      return `${STORAGE_PREFIX}sounds`;
    }

    // üîÅ Daily reset for daily users only (weekly plant keys are not cleared)
    const LAST_DATE_STORAGE_KEY = STORAGE_PREFIX + "lastDateKey";
    const lastDate = localStorage.getItem(LAST_DATE_STORAGE_KEY);
    if (lastDate && lastDate !== todayKey) {
      Object.keys(localStorage).forEach((k) => {
        // delete daily count keys (YYYY-MM-DD), keep weekly keys (contain "-W")
        if (k.startsWith(STORAGE_PREFIX + "count_") && !k.includes("-W")) {
          localStorage.removeItem(k);
        }
      });
    }
    localStorage.setItem(LAST_DATE_STORAGE_KEY, todayKey);

    // --- Encouragement ---
    function getEncouragement(count, goal, user) {
      if (user.cadence === "weekly") {
        return count >= goal ? "Plant is thriving üåø‚ú®" : "Water me once this week pls üôè";
      }
      if (count <= 0) return "Let‚Äôs get that first glass üëÄ";
      if (count < goal / 2) return "Nice start, keep sipping üíß";
      if (count < goal) return "So close to your goal!";
      return "Goal reached, hydration hero üí™";
    }

    // --- Sound toggle ---
    let soundsEnabled = localStorage.getItem(storageKeySounds()) !== "off";
    soundToggleInput.checked = soundsEnabled;
    soundToggleInput.addEventListener("change", () => {
      soundsEnabled = soundToggleInput.checked;
      localStorage.setItem(storageKeySounds(), soundsEnabled ? "on" : "off");
    });

    function playClickSound() {
      if (!soundsEnabled) return;
      const Ctx = window.AudioContext || window.webkitAudioContext;
      if (!Ctx) return;
      const ctx = new Ctx();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "sine";
      osc.frequency.value = 900;
      osc.connect(gain);
      gain.connect(ctx.destination);
      const t = ctx.currentTime;
      gain.gain.setValueAtTime(0.1, t);
      gain.gain.exponentialRampToValueAtTime(0.001, t + 0.13);
      osc.start(t);
      osc.stop(t + 0.13);
    }

    function playGoalSound() {
      if (!soundsEnabled) return;
      const Ctx = window.AudioContext || window.webkitAudioContext;
      if (!Ctx) return;
      const ctx = new Ctx();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "triangle";
      osc.frequency.value = 600;
      osc.connect(gain);
      gain.connect(ctx.destination);
      const t = ctx.currentTime;
      gain.gain.setValueAtTime(0.12, t);
      gain.gain.exponentialRampToValueAtTime(0.001, t + 0.25);
      osc.start(t);
      osc.stop(t + 0.25);
    }

    function launchConfetti() {
      for (let i = 0; i < 40; i++) {
        const piece = document.createElement("span");
        piece.className = "confetti-piece";
        piece.textContent = Math.random() < 0.5 ? "üíß" : "üéâ";
        piece.style.left = (Math.random() * 100) + "vw";
        piece.style.top = (5 + Math.random() * 20) + "vh";
        document.body.appendChild(piece);
        setTimeout(() => piece.remove(), 1200);
      }
    }

    // --- State ---
    let selectedUserId =
      localStorage.getItem(storageKeySelectedUser()) || USERS[0].id;

    const counts = {};
    const goals = {};
    const history = {};
    const lastSuccess = {};

    for (const u of USERS) {
      history[u.id] = {};

      const periodKey = getPeriodKeyForUser(u, now);
      const rawCount = Number(localStorage.getItem(storageKeyCount(u.id, periodKey)));
      counts[u.id] = Number.isFinite(rawCount) && rawCount >= 0 ? rawCount : 0;

      const rawGoal = Number(localStorage.getItem(storageKeyGoal(u.id)));
      let goal = (Number.isFinite(rawGoal) && rawGoal >= 1 && rawGoal <= MAX_GLASSES)
        ? rawGoal
        : (u.defaultGoal ?? 8);

      // Plant always fixed to 1 weekly
      if (u.cadence === "weekly") goal = 1;

      goals[u.id] = goal;
      lastSuccess[u.id] = counts[u.id] >= goals[u.id];
    }

    function updateStatusAndTimeLeft() {
      const selected = getUser(selectedUserId);
      if (selected.cadence === "weekly") {
        statusPill.textContent = "Weekly mode";
        statusPill.style.background = "#ecfdf5";
        statusPill.style.color = "#065f46";
        statusPill.style.borderColor = "#a7f3d0";
        timeLeftEl.textContent = "Plant goal resets each week üåø";
        return;
      }

      const now2 = new Date();
      const minutes = now2.getHours() * 60 + now2.getMinutes();
      const startMinutes = OFFICE_START_H * 60 + OFFICE_START_M;
      const endMinutes = OFFICE_END_H * 60 + OFFICE_END_M;

      if (minutes >= startMinutes && minutes < endMinutes) {
        statusPill.textContent = "In office hours";
        statusPill.style.background = "#ecfeff";
        statusPill.style.color = "#0369a1";
        statusPill.style.borderColor = "#bae6fd";

        const remaining = endMinutes - minutes;
        const h = Math.floor(remaining / 60);
        const m = remaining % 60;
        const labelHours = h > 0 ? `${h}h` : "";
        const labelMinutes = m > 0 ? `${m}m` : h === 0 ? "0m" : "";
        const name = getUser(selectedUserId).name;
        timeLeftEl.textContent = `${labelHours}${labelHours && labelMinutes ? " " : ""}${labelMinutes} left to reach ${name}'s goal today`;
      } else {
        statusPill.textContent = "Outside office hours";
        statusPill.style.background = "#fef3c7";
        statusPill.style.color = "#92400e";
        statusPill.style.borderColor = "#fed7aa";
        timeLeftEl.textContent = "Goal time is over for today. New streak starts tomorrow ‚ú®";
      }
    }

    function renderUserTabs() {
      userTabsEl.innerHTML = "";
      for (const u of USERS) {
        const btn = document.createElement("button");
        btn.className = "user-tab" + (u.id === selectedUserId ? " active" : "");
        btn.innerHTML = `<span class="emoji">${u.emoji}</span><span>${u.name}</span>`;
        btn.addEventListener("click", () => {
          if (selectedUserId !== u.id) {
            selectedUserId = u.id;
            localStorage.setItem(storageKeySelectedUser(), selectedUserId);
            renderUserTabs();
            updateView();
          }
        });
        userTabsEl.appendChild(btn);
      }
    }

    function didMeetGoalFromObj(dayObj) {
      if (!dayObj) return false;
      if (dayObj.goal_met === true) return true;
      const goal = dayObj.goal || 0;
      const count = dayObj.glasses_count || 0;
      return goal > 0 && count >= goal;
    }

    function computeStreak(userId) {
      const user = getUser(userId);

      if (user.cadence === "weekly") {
        let streak = 0;
        const thisWeek = weekKeyOffset(0);
        const metThisWeek = didMeetGoalFromObj(history[userId]?.[thisWeek]);
        const start = metThisWeek ? 0 : 1;

        for (let w = start; w < start + 52; w++) {
          const key = weekKeyOffset(-w);
          const met = didMeetGoalFromObj(history[userId]?.[key]);
          if (!met) break;
          streak++;
        }
        return streak;
      }

      // daily
      let streak = 0;
      const todayLocal = dayKeyOffset(0);
      const metToday = didMeetGoalFromObj(history[userId]?.[todayLocal]);
      const start = metToday ? 0 : 1;

      for (let d = start; d < start + 90; d++) {
        const key = dayKeyOffset(-d);
        const met = didMeetGoalFromObj(history[userId]?.[key]);
        if (!met) break;
        streak++;
      }
      return streak;
    }

    function renderGlasses() {
      const user = getUser(selectedUserId);
      const periodKey = getPeriodKeyForUser(user, new Date());
      const count = counts[selectedUserId] || 0;

      const max = user.cadence === "weekly" ? 1 : MAX_GLASSES;

      glassesRowEl.innerHTML = "";
      for (let i = 1; i <= max; i++) {
        const btn = document.createElement("button");
        btn.className = "glass-btn";

        const emptyIcon = user.cadence === "weekly" ? "ü™¥" : "ü•õ";
        const fullIcon  = user.cadence === "weekly" ? "üíß" : "üíß";

        btn.textContent = i <= count ? fullIcon : emptyIcon;
        if (i <= count) btn.classList.add("filled");

        btn.addEventListener("click", () => {
          const current = counts[selectedUserId] || 0;

          // UNFILL: only if clicking last filled item
          if (i === current) {
            const next = clamp(current - 1, 0, max);
            counts[selectedUserId] = next;
            localStorage.setItem(storageKeyCount(selectedUserId, periodKey), String(next));
            playClickSound();
            updateView();
            saveToCloud(selectedUserId).catch(console.error);
            return;
          }

          // FILL: drop first then fill
          const next = i;
          const rect = btn.getBoundingClientRect();
          const appRect = appEl.getBoundingClientRect();

          const drop = document.createElement("span");
          drop.className = "glass-drop";
          drop.textContent = "üíß";
          drop.style.left = (rect.left - appRect.left + rect.width / 2 - 9) + "px";
          drop.style.top  = (rect.top - appRect.top - 6) + "px";
          appEl.appendChild(drop);
          setTimeout(() => drop.remove(), 400);

          setTimeout(() => {
            counts[selectedUserId] = next;
            localStorage.setItem(storageKeyCount(selectedUserId, periodKey), String(next));
            playClickSound();
            updateView();

            const newBtn = glassesRowEl.children[i - 1];
            if (newBtn) {
              newBtn.classList.add("pop");
              setTimeout(() => newBtn.classList.remove("pop"), 250);
            }

            saveToCloud(selectedUserId).catch(console.error);
          }, 150);
        });

        glassesRowEl.appendChild(btn);
      }
    }

    function renderMeters() {
      metersListEl.innerHTML = "";
      for (const u of USERS) {
        const count = counts[u.id] || 0;
        const goal  = goals[u.id] || (u.cadence === "weekly" ? 1 : 8);
        const ratio = goal > 0 ? count / goal : 0;
        const pct   = clamp(ratio * 100, 0, 100);
        const success = goal > 0 && count >= goal;
        const streak = computeStreak(u.id);

        const card = document.createElement("div");
        card.className = "person-card";

        const streakLabel = u.cadence === "weekly" ? "week streak" : "day streak";
        card.title = `${u.name}: ${count}/${goal} ¬∑ ${streak}-${streakLabel}`;

        const inner = document.createElement("div");
        inner.className = "person-inner";

        const left = document.createElement("div");
        left.className = "person-left";

        const topRow = document.createElement("div");
        topRow.className = "person-toprow";

        const nameEl = document.createElement("div");
        nameEl.className = "meter-name";
        nameEl.innerHTML = `<span class="emoji">${u.emoji}</span><span>${u.name}</span>`;
        topRow.appendChild(nameEl);

        const bar = document.createElement("div");
        bar.className = "meter-bar";
        const innerBar = document.createElement("div");
        innerBar.className = "meter-inner";
        innerBar.style.width = pct + "%";
        innerBar.style.background = success
          ? "linear-gradient(90deg,#22c55e,#16a34a)"
          : "linear-gradient(90deg,#a5b4fc,#4c6fff)";
        bar.appendChild(innerBar);

        const text = document.createElement("div");
        text.className = "meter-text";
        const unit = u.cadence === "weekly" ? "this week" : "today";
        text.textContent = `${count}/${goal} ¬∑ ${unit}`;

        const msg = document.createElement("div");
        msg.className = "meter-message";
        msg.textContent = getEncouragement(count, goal, u);

        left.appendChild(topRow);
        left.appendChild(bar);
        left.appendChild(text);
        left.appendChild(msg);

        const right = document.createElement("div");
        right.className = "person-right";

        const streakMain = document.createElement("div");
        streakMain.className = "streak-main";

        const num = document.createElement("div");
        num.className = "streak-number";
        num.textContent = streak;

        const fire = document.createElement("div");
        fire.className = "streak-fire";
        fire.textContent = "üî•";

        streakMain.appendChild(num);
        streakMain.appendChild(fire);

        const label = document.createElement("div");
        label.className = "streak-label";
        label.textContent = u.cadence === "weekly" ? "week streak" : "day streak";

        right.appendChild(streakMain);
        right.appendChild(label);

        inner.appendChild(left);
        inner.appendChild(right);
        card.appendChild(inner);

        metersListEl.appendChild(card);
      }
    }

    function checkGoalCelebration() {
      const user = getUser(selectedUserId);
      const count = counts[user.id] || 0;
      const goal = goals[user.id] || (user.cadence === "weekly" ? 1 : 8);
      const success = goal > 0 && count >= goal;

      if (!lastSuccess[user.id] && success) {
        launchConfetti();
        playGoalSound();
      }
      lastSuccess[user.id] = success;
    }

    function updateGoalUI() {
      const user = getUser(selectedUserId);

      if (user.cadence === "weekly") {
        goalLabelEl.textContent = "Weekly goal for this person";
        goalUnitEl.textContent = "time";
        goalInputEl.value = "1";
        goalInputEl.disabled = true;
      } else {
        goalLabelEl.textContent = "Daily goal for this person";
        goalUnitEl.textContent = "glasses";
        goalInputEl.disabled = false;
        goalInputEl.value = goals[selectedUserId] || 8;
      }
    }

    function updateView() {
      updateGoalUI();
      renderGlasses();
      renderMeters();
      checkGoalCelebration();
      updateStatusAndTimeLeft();
    }

    async function saveToCloud(userId) {
      const user = getUser(userId);
      const periodKey = getPeriodKeyForUser(user, new Date());

      const max = user.cadence === "weekly" ? 1 : MAX_GLASSES;
      const count = clamp(counts[userId] || 0, 0, max);

      const goal = user.cadence === "weekly" ? 1 : (goals[userId] || 8);
      const goalMet = goal > 0 && count >= goal;

      const id = `${periodKey}_${userId}`;
      const ref = doc(db, "groups", GROUP_ID, "entries", id);

      await setDoc(ref, {
        groupId: GROUP_ID,
        period: user.cadence,         // "daily" | "weekly"
        period_key: periodKey,        // "YYYY-MM-DD" or "YYYY-W##"
        date: todayKey,               // keep for compatibility/debug
        user_id: userId,
        name: user.name,
        glasses_count: count,
        goal,
        goal_met: goalMet,
        updated_at: new Date().toISOString(),
      }, { merge: true });
    }

    function startFriendsListener() {
      const entriesCol = collection(db, "groups", GROUP_ID, "entries");
      const qAll = query(entriesCol);

      onSnapshot(qAll, (snapshot) => {
        for (const u of USERS) history[u.id] = history[u.id] || {};

        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const userId = data.user_id;
          if (!userId) return;

          const user = USERS.find(u => u.id === userId);
          if (!user) return;

          // prefer new field, fall back to old 'date'
          const key = data.period_key || data.date;
          if (!key) return;

          const day = history[userId][key] || {};

          if (typeof data.glasses_count === "number") {
            const max = user.cadence === "weekly" ? 1 : MAX_GLASSES;
            day.glasses_count = clamp(data.glasses_count, 0, max);
          }
          if (typeof data.goal === "number") {
            day.goal = user.cadence === "weekly" ? 1 : clamp(data.goal, 1, MAX_GLASSES);
          }
          if (typeof data.goal_met === "boolean") {
            day.goal_met = data.goal_met;
          }

          history[userId][key] = day;

          // update live counters only if this entry matches the CURRENT period key
          const currentKey = getPeriodKeyForUser(user, new Date());
          if (key === currentKey) {
            if (typeof day.glasses_count === "number") {
              counts[userId] = day.glasses_count;
              localStorage.setItem(storageKeyCount(userId, currentKey), String(day.glasses_count));
            }
            if (typeof day.goal === "number" && user.cadence !== "weekly") {
              goals[userId] = day.goal;
              localStorage.setItem(storageKeyGoal(userId), String(day.goal));
            }
          }
        });

        updateView();
      });
    }

    goalInputEl.addEventListener("change", () => {
      const user = getUser(selectedUserId);
      if (user.cadence === "weekly") return; // plant goal fixed

      let val = Number(goalInputEl.value);
      if (!Number.isFinite(val)) val = goals[selectedUserId] || 8;
      val = clamp(val, 1, MAX_GLASSES);

      goals[selectedUserId] = val;
      localStorage.setItem(storageKeyGoal(selectedUserId), String(val));
      updateView();
      saveToCloud(selectedUserId).catch(console.error);
    });

    dateEl.textContent = formatDatePretty(now);
    renderUserTabs();
    updateView();
    updateStatusAndTimeLeft();
    setInterval(updateStatusAndTimeLeft, 60 * 1000);
    startFriendsListener();
  </script>
</body>
</html>
