<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      doc,
      setDoc,
      collection,
      query,
      onSnapshot,
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  
    /* -------------------- FIREBASE -------------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyAh3Wqa8NSzdWIXRNBJ6TqYHgNm8y7faI",
      authDomain: "hydration-buddies-5fa86.firebaseapp.com",
      projectId: "hydration-buddies-5fa86",
      storageBucket: "hydration-buddies-5fa86.appspot.com",
      messagingSenderId: "23662841356",
      appId: "1:23662841356:web:41c2195ab1acb139439329",
    };
  
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const GROUP_ID = "hydration-besties";
  
    /* -------------------- USERS -------------------- */
    const USERS = [
      { id: "joan", name: "Joan", emoji: "ðŸ§â€â™€ï¸" },
      { id: "loes", name: "Loes", emoji: "ðŸ±" },
      { id: "john", name: "John", emoji: "ðŸ’ª" },
      { id: "plant", name: "Plant", emoji: "ðŸŒ¿" }, // ðŸŒ¿ weekly user
    ];
  
    const WEEKLY_USER_IDS = new Set(["plant"]);
    const WEEKLY_GOAL = 1;
    const MAX_GLASSES = 15;
  
    function isWeeklyUser(userId) {
      return WEEKLY_USER_IDS.has(userId);
    }
  
    /* -------------------- DATE HELPERS -------------------- */
    const today = new Date();
    const todayKey = today.toISOString().slice(0, 10);
  
    function isoWeekKey(date = new Date()) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const day = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - day);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      const week = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
      return `${d.getUTCFullYear()}-W${String(week).padStart(2, "0")}`;
    }
  
    const thisWeekKey = isoWeekKey(today);
  
    function periodKeyForUser(userId) {
      return isWeeklyUser(userId) ? thisWeekKey : todayKey;
    }
  
    function periodTypeForUser(userId) {
      return isWeeklyUser(userId) ? "week" : "day";
    }
  
    /* -------------------- STORAGE -------------------- */
    const STORAGE_PREFIX = "waterTracker_v12_";
  
    function storageKeyCount(userId) {
      return `${STORAGE_PREFIX}count_${periodTypeForUser(userId)}_${periodKeyForUser(userId)}_${userId}`;
    }
  
    function storageKeyGoal(userId) {
      return `${STORAGE_PREFIX}goal_${userId}`;
    }
  
    function storageKeySelectedUser() {
      return `${STORAGE_PREFIX}selectedUser`;
    }
  
    /* -------------------- RESET LOGIC -------------------- */
    const lastDayKey = STORAGE_PREFIX + "lastDay";
    const lastWeekKey = STORAGE_PREFIX + "lastWeek";
  
    if (localStorage.getItem(lastDayKey) !== todayKey) {
      Object.keys(localStorage)
        .filter(k => k.includes("count_day_"))
        .forEach(k => localStorage.removeItem(k));
      localStorage.setItem(lastDayKey, todayKey);
    }
  
    if (localStorage.getItem(lastWeekKey) !== thisWeekKey) {
      Object.keys(localStorage)
        .filter(k => k.includes("count_week_"))
        .forEach(k => localStorage.removeItem(k));
      localStorage.setItem(lastWeekKey, thisWeekKey);
    }
  
    /* -------------------- STATE -------------------- */
    const counts = {};
    const goals = {};
    const history = {};
    const lastSuccess = {};
  
    USERS.forEach(u => {
      counts[u.id] = Number(localStorage.getItem(storageKeyCount(u.id))) || 0;
      goals[u.id] = isWeeklyUser(u.id)
        ? WEEKLY_GOAL
        : Number(localStorage.getItem(storageKeyGoal(u.id))) || 8;
      history[u.id] = {};
      lastSuccess[u.id] = false;
    });
  
    let selectedUserId =
      localStorage.getItem(storageKeySelectedUser()) || USERS[0].id;
  
    /* -------------------- STREAKS -------------------- */
    function didMeetGoal(userId, key) {
      const d = history[userId]?.[key];
      if (!d) return false;
      return d.glasses_count >= (d.goal || 0);
    }
  
    function computeStreak(userId) {
      let streak = 0;
      const weekly = isWeeklyUser(userId);
  
      for (let i = 0; i < 30; i++) {
        const key = weekly
          ? isoWeekKey(new Date(Date.now() - i * 7 * 86400000))
          : new Date(Date.now() - i * 86400000).toISOString().slice(0, 10);
  
        if (didMeetGoal(userId, key)) streak++;
        else break;
      }
      return streak;
    }
  
    /* -------------------- UI -------------------- */
    const userTabsEl = document.getElementById("user-tabs");
    const glassesRowEl = document.getElementById("glasses-row");
    const goalInputEl = document.getElementById("goal-input");
    const metersListEl = document.getElementById("meters-list");
  
    function renderUserTabs() {
      userTabsEl.innerHTML = "";
      USERS.forEach(u => {
        const b = document.createElement("button");
        b.className = "user-tab" + (u.id === selectedUserId ? " active" : "");
        b.innerHTML = `<span class="emoji">${u.emoji}</span>${u.name}`;
        b.onclick = () => {
          selectedUserId = u.id;
          localStorage.setItem(storageKeySelectedUser(), u.id);
          updateView();
          renderUserTabs();
        };
        userTabsEl.appendChild(b);
      });
    }
  
    function renderGlasses() {
      glassesRowEl.innerHTML = "";
      const weekly = isWeeklyUser(selectedUserId);
      const max = weekly ? 1 : MAX_GLASSES;
  
      for (let i = 1; i <= max; i++) {
        const b = document.createElement("button");
        b.className = "glass-btn";
        b.textContent =
          i <= counts[selectedUserId] ? "ðŸ’§" : weekly ? "ðŸª´" : "ðŸ¥›";
        if (i <= counts[selectedUserId]) b.classList.add("filled");
  
        b.onclick = () => {
          counts[selectedUserId] = weekly
            ? counts[selectedUserId] ? 0 : 1
            : i;
  
          localStorage.setItem(
            storageKeyCount(selectedUserId),
            counts[selectedUserId]
          );
          saveToCloud(selectedUserId);
          updateView();
        };
  
        glassesRowEl.appendChild(b);
      }
    }
  
    function renderMeters() {
      metersListEl.innerHTML = "";
      USERS.forEach(u => {
        const streak = computeStreak(u.id);
        const pct = Math.min(
          100,
          (counts[u.id] / goals[u.id]) * 100
        );
  
        metersListEl.innerHTML += `
          <div class="person-card">
            <div class="person-inner">
              <div class="person-left">
                <div class="meter-name">${u.emoji} ${u.name}</div>
                <div class="meter-bar">
                  <div class="meter-inner" style="width:${pct}%"></div>
                </div>
                <div class="meter-text">${counts[u.id]}/${goals[u.id]}</div>
              </div>
              <div class="person-right">
                <div class="streak-number">${streak}</div>
                <div class="streak-label">${isWeeklyUser(u.id) ? "week" : "day"} streak</div>
              </div>
            </div>
          </div>`;
      });
    }
  
    function updateView() {
      const weekly = isWeeklyUser(selectedUserId);
      goalInputEl.value = weekly ? WEEKLY_GOAL : goals[selectedUserId];
      goalInputEl.disabled = weekly;
      renderGlasses();
      renderMeters();
    }
  
    /* -------------------- FIRESTORE -------------------- */
    async function saveToCloud(userId) {
      const key = periodKeyForUser(userId);
      const ref = doc(
        db,
        "groups",
        GROUP_ID,
        "entries",
        `${periodTypeForUser(userId)}_${key}_${userId}`
      );
  
      await setDoc(ref, {
        user_id: userId,
        name: USERS.find(u => u.id === userId).name,
        period: periodTypeForUser(userId),
        period_key: key,
        glasses_count: counts[userId],
        goal: goals[userId],
        goal_met: counts[userId] >= goals[userId],
      });
    }
  
    function startListener() {
      const q = query(collection(db, "groups", GROUP_ID, "entries"));
      onSnapshot(q, snap => {
        snap.forEach(d => {
          const x = d.data();
          history[x.user_id][x.period_key] = x;
          if (x.period_key === periodKeyForUser(x.user_id)) {
            counts[x.user_id] = x.glasses_count;
          }
        });
        updateView();
      });
    }
  
    /* -------------------- INIT -------------------- */
    renderUserTabs();
    updateView();
    startListener();
  </script>
  
