<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Water Check-in üíß</title>
  <style>
    :root {
      --bg: #f5f3ff;
      --card-bg: #ffffff;
      --accent: #4c6fff;
      --accent-soft: #c7d2ff;
      --text-main: #111827;
      --text-muted: #6b7280;
      --shadow: 0 18px 40px rgba(15, 23, 42, 0.16);
      --radius-lg: 18px;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top left, #e0f2fe, #f5f3ff 50%, #fee2e2);
      color: var(--text-main);
    }

    .app {
      background: var(--card-bg);
      border-radius: 26px;
      padding: 24px 26px 22px;
      width: 380px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(148, 163, 184, 0.18);
    }

    .app-header {
      margin-bottom: 10px;
    }

    .title {
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .title-emoji {
      font-size: 22px;
    }

    .date {
      margin-top: 4px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .sub {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .user-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
    }

    .user-tab {
      flex: 1;
      padding: 5px 0;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 12px;
      background: #f9fafb;
      color: #4b5563;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: background 0.15s ease, color 0.15s ease,
        border-color 0.15s ease, transform 0.08s ease;
    }

    .user-tab span.emoji {
      font-size: 14px;
    }

    .user-tab.active {
      background: #4c6fff;
      color: white;
      border-color: #4c6fff;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.35);
    }

    .goal-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .goal-row span.label {
      font-weight: 500;
      color: var(--text-main);
    }

    .goal-input {
      width: 56px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      padding: 4px 8px;
      font-size: 12px;
      text-align: center;
      outline: none;
    }

    .goal-input:focus {
      border-color: #4c6fff;
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.3);
    }

    .progress-wrap {
      margin-bottom: 12px;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
      font-size: 12px;
    }

    .progress-text {
      font-weight: 600;
    }

    .progress-percent {
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .trophy {
      font-size: 14px;
    }

    .progress-bar {
      width: 100%;
      height: 9px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
      position: relative;
    }

    .progress-inner {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #60a5fa, #4c6fff);
      transition: width 0.25s ease-out;
    }

    .glasses-row {
      display: flex;
      justify-content: space-between;
      margin: 10px 0 16px;
      gap: 6px;
      flex-wrap: wrap;
    }

    .glass-btn {
      flex: 1 1 calc(100% / 6 - 4px);
      border: none;
      background: #f3f4ff;
      border-radius: 999px;
      padding: 4px 0 3px;
      cursor: pointer;
      font-size: 19px;
      transition: transform 0.1s ease-out, box-shadow 0.1s ease-out,
        background 0.15s ease-out;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.12);
    }

    .glass-btn.filled {
      background: #dbeafe;
      box-shadow: 0 3px 8px rgba(37, 99, 235, 0.25);
    }

    .glass-btn:active {
      transform: translateY(1px) scale(0.97);
      box-shadow: 0 1px 4px rgba(15, 23, 42, 0.18);
    }

    .controls {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .btn {
      flex: 1;
      border-radius: 999px;
      border: none;
      padding: 7px 0;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.08s ease-out, box-shadow 0.12s ease-out,
        background 0.12s ease-out;
    }

    .btn-main {
      background: #4c6fff;
      color: white;
      box-shadow: 0 4px 14px rgba(37, 99, 235, 0.45);
    }

    .btn-main:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 2px 7px rgba(37, 99, 235, 0.35);
    }

    .btn-ghost {
      background: #eef2ff;
      color: #1e293b;
      box-shadow: 0 2px 6px rgba(148, 163, 184, 0.3);
    }

    .btn-ghost:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 1px 4px rgba(148, 163, 184, 0.25);
    }

    .office-note {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
      margin-bottom: 4px;
    }

    .pill {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #ecfeff;
      color: #0369a1;
      border: 1px solid #bae6fd;
    }

    .meters-card {
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px dashed rgba(148, 163, 184, 0.5);
      font-size: 12px;
    }

    .meters-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .meter-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 3px 0;
    }

    .meter-name {
      width: 70px;
      font-weight: 500;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .meter-bar {
      flex: 1;
      height: 6px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
      position: relative;
    }

    .meter-inner {
      height: 100%;
      background: linear-gradient(90deg, #a5b4fc, #4c6fff);
      width: 0%;
      transition: width 0.25s ease-out;
    }

    .meter-text {
      width: 70px;
      text-align: right;
      color: var(--text-muted);
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 4px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="title">
        <span class="title-emoji">üíß</span>
        <span>Water check-in</span>
      </div>
      <div class="date" id="date"></div>
    </header>

    <p class="sub">Choose who you‚Äôre tracking, then tap to log their glasses.</p>

    <div class="user-tabs" id="user-tabs"></div>

    <div class="goal-row">
      <span class="label">Daily goal</span>
      <span>
        <input id="goal-input" class="goal-input" type="number" min="1" max="12" />
        <span style="font-size:11px;color:var(--text-muted);">glasses</span>
      </span>
    </div>

    <div class="progress-wrap">
      <div class="progress-header">
        <span class="progress-text" id="progress-text"></span>
        <span class="progress-percent" id="progress-percent">
          <span id="percent-label"></span>
          <span id="trophy-main" class="trophy" style="display:none;">üèÜ</span>
        </span>
      </div>
      <div class="progress-bar">
        <div class="progress-inner" id="progress-inner"></div>
      </div>
    </div>

    <div class="glasses-row" id="glasses-row">
      <!-- glasses injected by JS -->
    </div>

    <div class="controls">
      <button class="btn btn-main" id="add-btn">Add a glass</button>
      <button class="btn btn-ghost" id="undo-btn">Undo</button>
    </div>

    <div class="office-note">
      <span>Office hours: 09:00‚Äì17:00</span>
      <span class="pill" id="status-pill">Today</span>
    </div>

    <div class="meters-card">
      <div class="meters-title">Today‚Äôs meter</div>
      <div id="meters-list"></div>
    </div>
  </div>

  <!-- Firebase + app logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      doc,
      setDoc,
      collection,
      query,
      where,
      onSnapshot,
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // üîê Your Firebase config (keep what you already pasted earlier)
    const firebaseConfig = {
  apiKey: "AIzaSyAh3Wqa8NSzdWIXRNBJ6TqYHgNm8y7faI",
  authDomain: "hydration-buddies-5fa86.firebaseapp.com",
  projectId: "hydration-buddies-5fa86",
  storageBucket: "hydration-buddies-5fa86.appspot.com",
  messagingSenderId: "23662841356",
  appId: "1:23662841356:web:41c2195ab1acb139439329",
  measurementId: "G-FVEE8GDG13"
};


    // Initialise Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Shared group id
    const GROUP_ID = "hydration-besties";

    // Three fixed users
    const USERS = [
      { id: "joan", name: "Joan", emoji: "ü™ª" },
      { id: "loes", name: "Loes", emoji: "üå∑" },
      { id: "john", name: "John", emoji: "ü™¥" },
    ];

    const MAX_GLASSES = 12;
    const OFFICE_START = 9;
    const OFFICE_END = 17;

    const STORAGE_PREFIX = "waterTracker_v2_";

    const today = new Date();
    const todayKey = today.toISOString().slice(0, 10); // YYYY-MM-DD

    // Elements
    const dateEl = document.getElementById("date");
    const userTabsEl = document.getElementById("user-tabs");
    const goalInputEl = document.getElementById("goal-input");
    const progressTextEl = document.getElementById("progress-text");
    const percentLabelEl = document.getElementById("percent-label");
    const trophyMainEl = document.getElementById("trophy-main");
    const progressInnerEl = document.getElementById("progress-inner");
    const glassesRowEl = document.getElementById("glasses-row");
    const addBtn = document.getElementById("add-btn");
    const undoBtn = document.getElementById("undo-btn");
    const statusPill = document.getElementById("status-pill");
    const metersListEl = document.getElementById("meters-list");

    function formatDatePretty(d) {
      return d.toLocaleDateString(undefined, {
        weekday: "long",
        day: "2-digit",
        month: "long",
        year: "numeric",
      });
    }

    function storageKeyCount(userId) {
      return `${STORAGE_PREFIX}count_${todayKey}_${userId}`;
    }

    function storageKeyGoal(userId) {
      return `${STORAGE_PREFIX}goal_${userId}`;
    }

    function storageKeySelectedUser() {
      return `${STORAGE_PREFIX}selectedUser`;
    }

    function clamp(val, min, max) {
      return Math.min(max, Math.max(min, val));
    }

    // Local state
    let selectedUserId =
      localStorage.getItem(storageKeySelectedUser()) || USERS[0].id;

    const counts = {};
    const goals = {};

    // Init counts and goals from localStorage
    for (const u of USERS) {
      const rawCount = Number(localStorage.getItem(storageKeyCount(u.id)));
      counts[u.id] =
        Number.isFinite(rawCount) && rawCount >= 0 ? rawCount : 0;

      const rawGoal = Number(localStorage.getItem(storageKeyGoal(u.id)));
      goals[u.id] =
        Number.isFinite(rawGoal) && rawGoal >= 1 && rawGoal <= MAX_GLASSES
          ? rawGoal
          : 8; // default goal
    }

    function updateStatusPill() {
      const hour = new Date().getHours();
      if (hour >= OFFICE_START && hour < OFFICE_END) {
        statusPill.textContent = "In office hours";
        statusPill.style.background = "#ecfeff";
        statusPill.style.color = "#0369a1";
        statusPill.style.borderColor = "#bae6fd";
      } else {
        statusPill.textContent = "Outside office hours";
        statusPill.style.background = "#fef3c7";
        statusPill.style.color = "#92400e";
        statusPill.style.borderColor = "#fed7aa";
      }
    }

    function renderUserTabs() {
      userTabsEl.innerHTML = "";
      for (const u of USERS) {
        const btn = document.createElement("button");
        btn.className =
          "user-tab" + (u.id === selectedUserId ? " active" : "");
        btn.innerHTML = `<span class="emoji">${u.emoji}</span><span>${u.name}</span>`;
        btn.addEventListener("click", () => {
          if (selectedUserId !== u.id) {
            selectedUserId = u.id;
            localStorage.setItem(storageKeySelectedUser(), selectedUserId);
            renderUserTabs();
            updateView();
          }
        });
        userTabsEl.appendChild(btn);
      }
    }

    function renderGlasses() {
      const count = counts[selectedUserId] || 0;
      glassesRowEl.innerHTML = "";
      for (let i = 1; i <= MAX_GLASSES; i++) {
        const btn = document.createElement("button");
        btn.className = "glass-btn";
        btn.textContent = i <= count ? "üíß" : "ü•õ";
        if (i <= count) btn.classList.add("filled");
        btn.addEventListener("click", () => {
          counts[selectedUserId] = i;
          localStorage.setItem(
            storageKeyCount(selectedUserId),
            String(i)
          );
          updateView();
          saveToCloud(selectedUserId).catch(console.error);
        });
        glassesRowEl.appendChild(btn);
      }
    }

    function renderMeters() {
      metersListEl.innerHTML = "";
      for (const u of USERS) {
        const count = counts[u.id] || 0;
        const goal = goals[u.id] || 8;
        const pct = clamp((count / MAX_GLASSES) * 100, 0, 100);
        const row = document.createElement("div");
        row.className = "meter-row";

        const nameEl = document.createElement("div");
        nameEl.className = "meter-name";
        nameEl.innerHTML = `<span>${u.emoji}</span><span>${u.name}</span>`;

        const bar = document.createElement("div");
        bar.className = "meter-bar";
        const inner = document.createElement("div");
        inner.className = "meter-inner";
        inner.style.width = pct + "%";
        bar.appendChild(inner);

        const text = document.createElement("div");
        text.className = "meter-text";
        const trophy =
          count >= goal ? "üèÜ" : "";
        text.innerHTML = `${count}/${goal} ${trophy}`;

        row.appendChild(nameEl);
        row.appendChild(bar);
        row.appendChild(text);
        metersListEl.appendChild(row);
      }
    }

    function updateView() {
      const count = counts[selectedUserId] || 0;
      const goal = goals[selectedUserId] || 8;
      const pctGoal = clamp((count / goal) * 100, 0, 999);
      const pctMax = clamp((count / MAX_GLASSES) * 100, 0, 100);

      goalInputEl.value = goal;
      progressTextEl.textContent = `${count} / ${goal} glasses`;
      percentLabelEl.textContent = Math.round(pctGoal) + "% of goal";
      progressInnerEl.style.width = pctMax + "%";

      trophyMainEl.style.display = count >= goal ? "inline" : "none";

      renderGlasses();
      renderMeters();
    }

    async function saveToCloud(userId) {
      const user = USERS.find((u) => u.id === userId);
      if (!user) return;

      const count = counts[userId] || 0;
      const goal = goals[userId] || 8;

      const id = `${todayKey}_${userId}`;
      const ref = doc(db, "groups", GROUP_ID, "entries", id);
      await setDoc(
        ref,
        {
          groupId: GROUP_ID,
          date: todayKey,
          user_id: userId,
          name: user.name,
          glasses_count: count,
          goal,
          updated_at: new Date().toISOString(),
        },
        { merge: true }
      );
    }

    function startFriendsListener() {
      const entriesCol = collection(db, "groups", GROUP_ID, "entries");
      const q = query(entriesCol, where("date", "==", todayKey));
      onSnapshot(q, (snapshot) => {
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const userId = data.user_id;
          if (!userId) return;
          if (typeof data.glasses_count === "number") {
            counts[userId] = clamp(data.glasses_count, 0, MAX_GLASSES);
            localStorage.setItem(
              storageKeyCount(userId),
              String(counts[userId])
            );
          }
          if (typeof data.goal === "number") {
            goals[userId] = clamp(data.goal, 1, MAX_GLASSES);
            localStorage.setItem(
              storageKeyGoal(userId),
              String(goals[userId])
            );
          }
        });
        updateView();
      });
    }

    // Events
    addBtn.addEventListener("click", () => {
      const current = counts[selectedUserId] || 0;
      if (current >= MAX_GLASSES) return;
      counts[selectedUserId] = current + 1;
      localStorage.setItem(
        storageKeyCount(selectedUserId),
        String(counts[selectedUserId])
      );
      updateView();
      saveToCloud(selectedUserId).catch(console.error);
    });

    undoBtn.addEventListener("click", () => {
      const current = counts[selectedUserId] || 0;
      if (current <= 0) return;
      counts[selectedUserId] = current - 1;
      localStorage.setItem(
        storageKeyCount(selectedUserId),
        String(counts[selectedUserId])
      );
      updateView();
      saveToCloud(selectedUserId).catch(console.error);
    });

    goalInputEl.addEventListener("change", () => {
      let val = Number(goalInputEl.value);
      if (!Number.isFinite(val)) val = goals[selectedUserId] || 8;
      val = clamp(val, 1, MAX_GLASSES);
      goals[selectedUserId] = val;
      localStorage.setItem(
        storageKeyGoal(selectedUserId),
        String(val)
      );
      updateView();
      saveToCloud(selectedUserId).catch(console.error);
    });

    // Initial render
    dateEl.textContent = formatDatePretty(today);
    updateStatusPill();
    setInterval(updateStatusPill, 10 * 60 * 1000);

    renderUserTabs();
    updateView();
    startFriendsListener();
  </script>
</body>
</html>
